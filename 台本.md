# 台本

## 1ページ目

## 2ページ目
スピーカーは重度の聴覚障害ありのため、発音が不明瞭です。<br />
聞き取りにくい内容が多々あると思いますので、台本を用意しました。<br />
台本はgithubに挙げてあります。<br />
URLはこちらです。<br />
質問、突っ込み事項はお手数おかけしますが、ご覧のハッシュタグを付けてTwitterで呟いてください。<br />

## 3ページ目
自己紹介です。<br />
渋谷のSIerで働いています。<br />
Twitterアイコンにつかっている、この画像は私が今つけている補聴器、これを落として割れてしまった時のものです。<br />
Javaはまだ載っていない、と思いますので補聴器に関するJavaエンジニアを目指している方は是非とも参考にしてください。<br />

## 4ページ目
よく見るパフォーマンス測定結果と、JMHで書いたパフォーマンス測定結果を見比べてみたいと思います。<br />
今から2通りの処理結果をお見せします。

## 5ページ目
何やら文字列と、数値みたいなものがコンソールに出ている、シンプルな結果ですね。

## 6ページ目
先ほどの出力結果とは違い、何やら色々と出力されています。

## 7ページ目
比較①と比較②、どちらがテスト結果として出されたときわかりやすいでしょうか？<br />
ちょっと挙手してみてもらえますか？<br />
（5ページ目に戻る）<br />
こちらがわかりやすいと思う方？<br />
ありがとうございました。<br />
（6ページ目に戻る）<br />
こちらがわかりやすいと思う方？<br />
ありがとうございました。<br />

## 8ページ目
比較②の方が何やら情報量が多くていいですよね！

## 9ページ目
目次というほどでもありませんが、この流れでお話しします。

## 10ページ目
皆さん、JMHというツールの存在を知っていますか？<br />
もう一度挙手形式でお願いします。<br />
一番、知らなかった方？<br />
二番、名前は知っているが、使ったことはない方？<br />
三番、名前を知っていて使ったことがある方？<br />
ありがとうございました。

## 11ページ目
JMHとは何の略称なのでしょうか。<br />
mavenのページによると、Microbenchmark Harnessと書かれています。<br />
この頭文字をとってJMHと呼ばれているようです。

## 12ページ目
配布元のページにはこのような説明文があります。<br />
英語で書かれているのですが、ざっくりいうと、Javaや、JVMをターゲットとした言語で書かれたプログラムのベンチマークをとるツールです。

## 13ページ目
配布元はOpenJDKで、現在のリリースバージョンは1.16です。<br />
1.16は今年の11/9にリリースされたばかりです。<br />

## 14ページ目
使うための手順はこちらです。
1. JDKをインストールします。
2. mavenをインストールします。
3. mavenコマンドを打って、プロジェクトのひな形を作成します。
4. ひな形を編集します。
5. コンパイルします。
6. 実行します。

## 15ページ目
JDKのインストールですが、私が確認したのはJDK7からJDK9までです。<br />
ただし、JDK9はEarly Access Releases版です。

## 16ページ目
Mavenのインストール方法は各自、調べてください。

## 17ページ目
JMHはこちらのmavenコマンドを打つことで、ひな形を作成できます。<br />
pom.xmlを自分で書いてもいいのですが、mavenコマンドで作るほうが簡単かな、と私は思っています。

## 18ページ目
MyBenchmark.java が生成されており、その中にテスト用メソッド、testMethod()があります。<br />
この中に、テストしたいロジックを記述します。

## 19ページ目
テスト対象のメソッドは複数書くことが可能です。<br />
テストしたいメソッドに、@Benchmark アノテーションを付けてください。

## 20ページ目
例えば、こちらの例ですと、上の4つのメソッドは@Benchmarkアノテーションがついていますのでテスト対象となります。<br />
下のメソッドはアノテーションがついていませんので、テスト対象となりません。

## 21ページ目
コンパイルするときは、mvn clean install コマンドを打つ必要があります。<br />
コマンドを打つと、targetディレクトリの下に benchmarks.jar が生成されます。

## 22ページ目
なぜ変更時は毎回clean installしないといけないのでしょうか。<br />
それは、コンパイル時に、自動で生成されるクラスがあり、これらのクラスが実際の測定を担っているためです。<br />
そのため、コンパイルは必須です。

## 23ページ目
実行するときは、このコマンドを打ちます。<br />
デフォルトでのテストモードは以下となっています。
- ウォームアップ回数：20回
- テスト回数：20回
- 繰り返し回数：10回

## 24ページ目
つまり、ウォームアップで20回処理した後、測定対象で20回処理、を10回繰り返します。<br />
意外と時間がかかりますので、ちょっと試す、というときには回数を減らして流すことをお勧めします。<br />
業務で明確な基準を決めて使うときは、自分の業務に合った回数を試行錯誤して定めることをお勧めします。<br />

## 25ページ目
回数の減らし方はいくつかあります。
まず、実行時の引数で指定することができます。<br />
java -jar target/benchmarks.jar -wi 5 -i 5 -f 2<br />
それぞれのオプションはこのようになっています。
-wi :ウォームアップ回数
-i：テスト回数
-f：繰り返し回数

## 26ページ目
テストプログラムの中で指定することもできます。<br />
赤枠で囲んだところを見てください。<br />
アノテーションが3つ書いてあります。<br />
上から順に、ウォームアップ回数、テスト回数、繰り返し回数を指定しています。

## 27ページ目
ここからは実行結果の見方です。<br />
Javaのバージョンやパス、今回のテスト回数、メソッドなどの情報がまず出力されます。

## 28ページ目
次に、ウォームアップ、3回分の処理結果が出力されます。<br />
そして、測定対象、3回分の処理結果が出力されます。<br />
Forkで複数回指定している場合は、Forkの回数分表示されます。<br />
最後に、簡単な処理結果が表示されます。

## 29ページ目
テスト対象のメソッド、全てを測定し終えたら、最後に結果がまとめて表示されます。<br />
今回のテスト結果だと、1秒当たりで処理できる回数はtest4StringBuilderが一番多いということがわかります。

## 30ページ目
今見ていただいた実行結果と同じプログラムを実際に流してみたいと思います。
ご覧いただくとわかるように、ウォームアップの1回目、2回目とそれ以降で処理速度が若干よくなり、一定の処理速度になっています。
詳しいことは省きますが、これがパフォーマンステストの難しいところですね。

## 31ページ目
ここからは注意点についてです。
マイクロベンチマークツールなので、プログラム全体の測定に使うのは向いていません。
プログラム全体の速度を測るときは別の方法を検討してください。

## 32ページ目
テスト対象のコードに誤りがあっても、誤りはチェックしません。<br />
書いてあるロジックで速度を測定しますので、正しいロジックになっていることを確認してから流しましょう。

## 33ページ目
プログラムが遅いといっても、全体が遅いわけではありません。<br />
どこかのロジックがボトルネックとなっています。<br />
ボトルネックとなっている個所及び、チューニング案の処理速度を測定して比較する用途が向いています。<br />
なお、ボトルネックとなっている個所がデータベースアクセスやファイルアクセス、外部サービスとのやり取りであったときはJMHは使わずに、別のやり方で速度測定をしたほうがいいかと思います。

## 34ページ目
メモリ使用量は測定していないので、メモリ使用量が気になる場合は別途測定する必要があります。

## 35ページ目
そもそも、パフォーマンステストとはなにぞや？については、オイラリー社から出ているJavaパフォーマンスという本を読むのをおすすめします。

## 36ページ目
まとめます。
パフォーマンステストツール、JMHについてご紹介しました。<br />
JMHを使ってテストすると、処理結果の違いがミリ秒で挟んだ結果と違っていろいろ出てくるので楽しくなって来ます。（個人の感想です）

## 37ページ目
今回は時間の都合で詳しくお話し出来ませんでしたが、JMHでは、色々なモードでテストが出来ます。<br />
このあたりも参考になるかと思います。

## 38ページ目
JMHを使い始めると楽しいよ！

## 39ページ目
ご清聴ありがとうございました。